<!doctype html>
<!-- File: index.html -->
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>GlobalProtect Proxy</title>
        <style>
            :root {
                --bg-body: #f8fafc;
                --bg-card: #ffffff;
                --text-primary: #0f172a;
                --text-secondary: #64748b;
                --border-color: #e2e8f0;
                --input-bg: #ffffff;
                --accent-blue: #2563eb;
                --accent-hover: #1d4ed8;
                --accent-red: #ef4444;
                --accent-green: #10b981;
                --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
                --font-family: "Inter", sans-serif;
                --radius-md: 12px;
            }

            [data-theme="dark"] {
                --bg-body: #0f172a;
                --bg-card: #1e293b;
                --text-primary: #f8fafc;
                --text-secondary: #94a3b8;
                --border-color: #334155;
                --input-bg: #0f172a;
                --accent-blue: #3b82f6;
                --accent-hover: #60a5fa;
            }

            body {
                margin: 0;
                padding: 0;
                font-family: var(--font-family);
                background: var(--bg-body);
                color: var(--text-primary);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }

            .card {
                background: var(--bg-card);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                box-shadow: var(--shadow-lg);
                width: 100%;
                max-width: 440px;
                padding: 40px 32px;
                text-align: center;
                position: relative;
            }

            h1 {
                font-size: 1.5rem;
                margin: 0 0 8px 0;
            }

            .subtitle {
                font-size: 0.875rem;
                color: var(--text-secondary);
                margin: 0;
            }

            .hidden {
                display: none !important;
            }

            .btn {
                width: 100%;
                padding: 14px;
                border-radius: var(--radius-md);
                border: none;
                font-weight: 600;
                cursor: pointer;
                margin-top: 16px;
            }

            .btn-primary {
                background: var(--accent-blue);
                color: white;
            }

            .btn-danger {
                background: transparent;
                border: 1px solid var(--accent-red);
                color: var(--accent-red);
            }

            .badge {
                display: inline-flex;
                padding: 6px 12px;
                border-radius: 99px;
                font-size: 0.75rem;
                font-weight: 600;
                margin-bottom: 24px;
                border: 1px solid transparent;
            }

            .badge.connected {
                background: rgba(16, 185, 129, 0.1);
                color: var(--accent-green);
                border-color: rgba(16, 185, 129, 0.2);
            }

            .info-box {
                background: var(--bg-body);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 16px;
                text-align: left;
                margin: 12px 0;
                font-size: 0.9rem;
            }

            .info-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .info-label {
                color: var(--text-secondary);
            }

            .info-val {
                font-weight: 600;
                font-family: monospace;
            }

            input {
                width: 100%;
                padding: 12px;
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                background: var(--input-bg);
                color: var(--text-primary);
                margin-bottom: 16px;
                box-sizing: border-box;
            }

            /* Icons */
            .icon-btn {
                background: none;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                position: absolute;
                top: 32px;
                right: 32px;
            }

            .spinner {
                width: 24px;
                height: 24px;
                border: 3px solid var(--border-color);
                border-top-color: var(--accent-blue);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>

    <body>
        <div class="card">
            <button class="icon-btn" onclick="confirmReset()" title="Reset">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                    <line x1="12" y1="2" x2="12" y2="12"></line>
                </svg>
            </button>
            <h1>GlobalProtect</h1>
            <p class="subtitle">Secure Proxy Gateway</p>
            <div id="status-badge" class="badge idle">System Ready</div>

            <div id="view-idle" class="hidden">
                <p>Ready to connect.</p>
                <button onclick="triggerConnect()" class="btn btn-primary">Connect</button>
            </div>

            <div id="view-connecting" class="hidden">
                <div class="spinner"></div>
                <h3>Connecting...</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem">Handshaking with gateway</p>
            </div>

            <div id="view-auth" class="hidden">
                <h3>SSO Login Required</h3>
                <a
                    id="sso-link"
                    href="#"
                    target="_blank"
                    class="btn btn-primary"
                    onclick="this.classList.add('disabled')"
                    >Open Login Page</a
                >
                <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 24px 0" />
                <form onsubmit="handleForm(event)">
                    <input type="text" name="callback_url" placeholder="Paste callback URL here..." required />
                    <button type="submit" class="btn btn-primary">Verify</button>
                </form>
            </div>

            <div id="view-input" class="hidden">
                <h3 id="input-prompt">Input Required</h3>
                <form onsubmit="handleForm(event)">
                    <div id="dynamic-input"></div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>

            <div id="view-connected" class="hidden">
                <h2 style="color: var(--accent-green)">Tunnel Active</h2>

                <div id="info-socks" class="info-box hidden">
                    <div style="font-weight: 700; margin-bottom: 12px; color: var(--text-primary)">SOCKS5 Proxy</div>
                    <div class="info-row"><span class="info-label">Port</span><span class="info-val">1080</span></div>
                    <div class="info-row">
                        <span class="info-label">Auth</span><span class="info-val">None (Allow List)</span>
                    </div>
                </div>

                <div id="info-gateway" class="info-box hidden">
                    <div style="font-weight: 700; margin-bottom: 12px; color: var(--text-primary)">
                        Transparent Gateway
                    </div>
                    <div class="info-row">
                        <span class="info-label">Interface</span><span class="info-val">tun0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Routing</span><span class="info-val">Full Tunnel (NAT)</span>
                    </div>
                </div>

                <button onclick="triggerDisconnect()" class="btn btn-danger">Disconnect</button>
            </div>

            <div id="view-error" class="hidden">
                <h3 style="color: var(--accent-red)">Connection Failed</h3>
                <p id="error-msg">Unknown error.</p>
                <button onclick="triggerConnect()" class="btn btn-primary">Retry</button>
            </div>
        </div>

        <script>
            window.vpnState = null;

            function setView(id) {
                document.querySelectorAll('[id^="view-"]').forEach((el) => el.classList.add("hidden"));
                document.getElementById("view-" + id).classList.remove("hidden");
            }

            async function triggerConnect() {
                setView("connecting");
                await fetch("/connect", { method: "POST" });
            }

            async function triggerDisconnect() {
                if (confirm("Disconnect?")) await fetch("/disconnect", { method: "POST" });
            }

            async function confirmReset() {
                if (confirm("Reset process?")) await fetch("/disconnect", { method: "POST" });
            }

            async function handleForm(e) {
                e.preventDefault();
                const data = new URLSearchParams(new FormData(e.target));
                await fetch("/submit", { method: "POST", body: data });
                setView("connecting");
                e.target.reset();
            }

            async function poll() {
                try {
                    const res = await fetch("/status.json?t=" + Date.now());
                    const data = await res.json();

                    // Show/Hide Info Boxes based on Mode
                    const showGateway = data.vpn_mode === "gateway" || data.vpn_mode === "standard";
                    const showSocks = data.vpn_mode === "socks" || data.vpn_mode === "standard";

                    document.getElementById("info-gateway").classList.toggle("hidden", !showGateway);
                    document.getElementById("info-socks").classList.toggle("hidden", !showSocks);

                    if (window.vpnState !== data.state) {
                        setView(data.state);
                        window.vpnState = data.state;

                        const badge = document.getElementById("status-badge");
                        badge.className = `badge ${data.state}`;
                        badge.innerText = data.state.toUpperCase();
                    }

                    // Dynamic Data
                    if (data.url) document.getElementById("sso-link").href = data.url;
                    if (data.error) document.getElementById("error-msg").innerText = data.error;

                    // Input handling
                    if (data.state === "input") {
                        document.getElementById("input-prompt").innerText = data.prompt;
                        const container = document.getElementById("dynamic-input");
                        if (!container.innerHTML) {
                            container.innerHTML = `<input type="${data.input_type === "password" ? "password" : "text"}" name="user_input" required>`;
                        }
                    }
                } catch (e) {}
            }
            setInterval(poll, 1500);
            poll();
        </script>
    </body>
</html>
