FROM debian:bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

# 1. Install runtime dependencies & tools
#    - libcap2-bin: used for setcap (to give non-root user network perms)
#    - microsocks, python3: for your proxy and dashboard
#    - libraries: required by the GlobalProtect .deb
RUN apt-get update && apt-get install -y \
    wget \
    ca-certificates \
    microsocks \
    python3 \
    iptables \
    iproute2 \
    libcap2-bin \
    libgtk-3-0 \
    libwebkit2gtk-4.1-0 \
    libayatana-appindicator3-1 \
    librsvg2-common \
    --no-install-recommends && \
    rm -rf /var/lib/apt/lists/*

# 2. Download and Install the Pre-built .deb
RUN wget -q https://github.com/yuezk/GlobalProtect-openconnect/releases/download/v2.5.1/globalprotect-openconnect_2.5.1-1_amd64.deb -O /tmp/gp.deb && \
    apt-get install -y /tmp/gp.deb && \
    rm /tmp/gp.deb

# 3. Create a non-root user 'gpuser'
RUN useradd -m -s /bin/bash gpuser

# 4. Grant Network Capabilities to the binary
#    This allows 'gpservice' to modify network interfaces (tun0)
#    without being full 'root' user.
RUN setcap 'cap_net_admin+ep' /usr/bin/gpservice

# 5. Setup directories and permissions
#    Ensure gpuser can write to logs and the web directory
RUN mkdir -p /var/www/html /tmp/gp-logs && \
    chown -R gpuser:gpuser /var/www/html /tmp/gp-logs

# 6. Setup start script
COPY start.sh /start.sh
RUN chmod +x /start.sh

EXPOSE 1080 8001

ENTRYPOINT ["/start.sh"]